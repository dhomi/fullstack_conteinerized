{% extends 'homepage.html' %}
{% load static %}

{% block title %}Sporting Articles{% endblock %}

{% block content %}
<meta name="description" content="List of sporting articles with options to add to cart or manage articles.">
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css">
<script type="text/javascript" src="https://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

<div class="container" style="margin-top: 20px;">
  <h2>Sporting Articles</h2>

  <table id="sportsArticlesTable" class="table table-striped table-bordered table-sm">
    <thead>
      <tr>
        <th>Product Code</th>
        <th>Product Name</th>
        <th>Category</th>
        <th>Size</th>
        <th>Color</th>
        <th>Price</th>

        {% if request.session.role == 'admin' %}
          <th>Stock Quantity</th>
          <th>Stock Minimum</th>
          <th>VAT Type</th>
          <th>Actions</th>
        {% elif request.session.role == 'customer' %}
          <th>Add to Cart</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for article in sports_articles %}
        <tr id="row-{{ article.article_code }}">
          <td>{{ article.article_code }}</td>

          <!-- Admin can edit in place; for customer, just display text -->
          {% if request.session.role == 'admin' %}
            <td contenteditable="true" class="editable" data-field="article_name">
              {{ article.article_name }}
            </td>
            <td contenteditable="true" class="editable" data-field="category">
              {{ article.category }}
            </td>
            <td contenteditable="true" class="editable" data-field="size">
              {{ article.size }}
            </td>
            <td contenteditable="true" class="editable" data-field="color">
              {{ article.color }}
            </td>
            <td contenteditable="true" class="editable" data-field="price">
              {{ article.price }}
            </td>
            <td contenteditable="true" class="editable" data-field="stock_quantity">
              {{ article.stock_quantity }}
            </td>
            <td contenteditable="true" class="editable" data-field="stock_min">
              {{ article.stock_min }}
            </td>
            <td contenteditable="true" class="editable" data-field="vat_type">
              {{ article.vat_type }}
            </td>
            <td style="display: flex; gap: 4px; justify-content: center;">
              <!-- Update Button -->
              <button class="btn btn-primary btn-sm"
                onclick="updateSportArticle({{ article.article_code }})">
                Update
              </button>
              <!-- Delete Button -->
              <button class="btn btn-danger btn-sm"
                onclick="deleteSportArticle({{ article.article_code }})">
                Delete
              </button>
            </td>

          {% elif request.session.role == 'customer' %}
            <td>{{ article.article_name }}</td>
            <td>{{ article.category }}</td>
            <td>{{ article.size }}</td>
            <td>{{ article.color }}</td>
            <td>{{ article.price }}</td>
            <td>
              <!-- Instead of a standard POST form, do AJAX for "Add to Cart" -->
              <input type="number" id="quantity-{{ article.article_code }}"
                     value="1" min="1" class="form-control"
                     style="width: 60px; display: inline-block;" />
              <button class="btn btn-success btn-sm"
                      onclick="addToCartAjax({{ article.article_code }})">
                Add to Cart
              </button>
            </td>
          {% endif %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  // --- Initialize DataTable ---
  $(document).ready(function() {
    $('#sportsArticlesTable').DataTable({
      paging: true,
      searching: true,
      ordering: true,
      info: true,
      autoWidth: false,
      pageLength: 8
    });
  });

  // --- Functions for ADMIN (Update / Delete) ---
  function updateSportArticle(articleCode) {
    const row = document.getElementById(`row-${articleCode}`);
    const updatedData = {};

    $(row).find('.editable').each(function() {
      const fieldName = $(this).data('field');
      const fieldValue = $(this).text().trim();
      updatedData[fieldName] = fieldValue;
    });

    $.ajax({
      url: `/sports_articles/update/${articleCode}/`,
      type: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify(updatedData),
      success: function(response) {
        alert('Sport article updated successfully!');
        location.reload(); // or optionally just stay on the page
      },
      error: function(err) {
        const errorMsg = err.responseJSON && err.responseJSON.detail 
          ? err.responseJSON.detail 
          : 'Failed to update sport article.';
        alert(errorMsg);
      }
    });
  }

  function deleteSportArticle(articleCode) {
    if (!confirm("Are you sure you want to delete this article?")) return;

    $.ajax({
      url: `/sports_articles/delete/${articleCode}/`,
      type: 'DELETE',
      success: function(response) {
        alert('Sport article deleted successfully!');
        location.reload();
      },
      error: function(err) {
        const errorMsg = err.responseJSON && err.responseJSON.detail 
          ? err.responseJSON.detail 
          : 'Failed to delete sport article.';
        alert(errorMsg);
      }
    });
  }

  // --- AJAX Add to Cart for CUSTOMERS ---
  function addToCartAjax(articleCode) {
    const quantity = document.getElementById("quantity-" + articleCode).value;

    $.ajax({
      url: "{% url 'add_to_cart' 0 %}".replace("/0/", "/" + articleCode + "/"),
      type: "POST",
      data: {
        // Django form-based POST data
        quantity: quantity,
        csrfmiddlewaretoken: "{{ csrf_token }}"
      },
      success: function(response) {
        // This might be JSON if your view returns JsonResponse
        // or it might just redirect. If it's JSON, we can do:
        if (response.message) {
          alert(response.message);
        } else {
          alert("Item added to cart successfully!");
        }

        // Now update the cart count at the top
        // (Assumes you have a JS function in homepage.html called updateCartCount)
        updateCartCount();
      },
      error: function(err) {
        const errorDetail = err.responseJSON && err.responseJSON.detail 
          ? err.responseJSON.detail 
          : "Failed to add item to cart.";
        alert(errorDetail);
      }
    });
  }
  $("#myAddToCartForm").on("submit", function(e) {
  e.preventDefault();  // Stop normal redirect
  // then do your AJAX call
});

</script>
{% endblock %}
