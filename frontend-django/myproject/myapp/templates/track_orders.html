{% extends 'homepage.html' %}

{% block title %}Track Orders{% endblock %}

{% block content %}
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

<div class="container" style="margin-top: 40px;">
    <h3>Track Your Orders</h3>
    <div class="input-group" style="margin-bottom: 20px; width: 50%; margin: auto;">
        <input type="number" class="form-control" id="order_number" placeholder="Enter Order Number" aria-label="Order Number">
        <span class="input-group-btn">
            <button class="btn btn-primary" type="button" onclick="trackOrder()">Track</button>
        </span>
    </div>
    
    <div id="orderDetails" style="margin-top: 20px; display: none;">
        <h4>Order Details</h4>
        <div class="card" style="padding: 20px; border-radius: 10px; box-shadow: 0px 4px 8px rgba(0,0,0,0.1);">
            <p><strong>Order Number:</strong> <span id="detailOrderNumber"></span></p>
            <p><strong>Supplier Code:</strong> <span id="detailSupplierCode"></span></p>
            <p><strong>Order Date:</strong> <span id="detailOrderDate"></span></p>
            <p><strong>Delivery Date:</strong> <span id="detailDeliveryDate"></span></p>
            <p><strong>Status:</strong> <span id="detailStatus"></span></p>
            <p><strong>Tracking Number:</strong> <span id="detailTrackingNumber"></span></p>
        </div>
    </div>
</div>

<script>
    function trackOrder() {
        const orderNumber = document.getElementById('order_number').value;
        if (!orderNumber) {
            alert("Please enter an order number.");
            return;
        }

        // CSRF Token and Access Token logic
        const csrfToken = '{{ csrf_token }}'; // Ensure CSRF token is available
        const accessToken = "{{ request.session.access_token|default:'' }}";

        if (!accessToken) {
            alert("You need to log in to track your order.");
            return;
        }

        $.ajax({
            url: `http://localhost:8000/trackorder/${orderNumber}`,
            type: 'GET',
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "X-CSRFToken": csrfToken // Include CSRF token for security
            },
            success: function(response) {
                // Fill order details if successfully fetched
                $('#orderDetails').show();
                $('#detailOrderNumber').text(response.order_number);
                $('#detailSupplierCode').text(response.supplier_code);
                $('#detailOrderDate').text(response.order_date);
                $('#detailDeliveryDate').text(response.delivery_date);
                $('#detailStatus').text(response.status);
                $('#detailTrackingNumber').text(response.tracking_info ? response.tracking_info.tracking_number : "N/A");
            },
            error: function(err) {
                alert("Failed to fetch order details: " + err.responseText);
                $('#orderDetails').hide();
            }
        });
    }
</script>
{% endblock %}
