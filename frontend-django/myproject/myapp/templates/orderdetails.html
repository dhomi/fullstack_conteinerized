{% extends 'homepage.html' %}

{% block title %}Order Details{% endblock %}

{% block content %}
<meta name="description" content="Bootstrap.">
<link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<link rel="stylesheet" href="http://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css">
<script type="text/javascript" src="http://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

<h2>Order Details</h2>

<table id="myTable" class="table table-striped table-bordered table-responsive">
    <thead>
        <tr>
            <th>Supplier Code</th>
            <th>Order Number</th>
            <th>Product Code</th>
            <th>Product Name</th>
            <th>Order Price</th>
            <th>Order Date</th>
            <th>Delivery Date</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for order in orderdetails %}
            <tr>
                <form class="update-order-form" data-order-number="{{ order.order_number }}">
                    {% csrf_token %}
                    <td>
                        {{ order.supplier_code }}
                        <input type="hidden" name="supplier_code" value="{{ order.supplier_code }}">
                    </td>
                    <td>
                        {{ order.order_number }}
                        <input type="hidden" name="order_number" value="{{ order.order_number }}">
                    </td>
                    <td>
                        {{ order.article_code }}
                        <input type="hidden" name="article_code" value="{{ order.article_code }}">
                    </td>
                    <td>{{ order.article_name }}</td>
                    <td>
                        <div class="form-group">
                            <input type="text" name="order_price" value="{{ order.order_price }}" class="form-control input-sm">
                        </div>
                    </td>
                    <td>
                        {{ order.order_date }}
                        <input type="hidden" name="order_date" value="{{ order.order_date }}">
                    </td>
                    <td>
                        <div class="form-group">
                            <input type="date" name="delivery_date" value="{{ order.delivery_date }}" class="form-control input-sm">
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <select name="status" class="form-control input-sm">
                                <option value="P" {% if order.status == "P" %}selected{% endif %}>Pending</option>
                                <option value="C" {% if order.status == "C" %}selected{% endif %}>Cancelled</option>
                                <option value="S" {% if order.status == "S" %}selected{% endif %}>Shipped</option>
                                <option value="D" {% if order.status == "D" %}selected{% endif %}>Delivered</option>
                            </select>
                        </div>
                    </td>
                    <td>
                        <button type="submit" class="btn btn-primary btn-sm">Update</button>
                    </td>
                </form>
            </tr>
        {% endfor %}
    </tbody>
</table>

<div class="form-group">
    <button type="button" class="btn btn-default">
        <a href="/ordermanagement/orders" style="text-decoration: none; color: inherit;">Back to All Orders</a>
    </button>
    <button type="button" class="btn btn-default">
        <a href="/suppliers" style="text-decoration: none; color: inherit;">Back to All Suppliers</a>
    </button>
</div>

<script>
    // Get the CSRF token from Django's cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    $(document).ready(function () {
        // Initialize DataTable if needed
        $('#myTable').DataTable();

        // Handle form submissions
        $('form.update-order-form').on('submit', function (event) {
            event.preventDefault();

            const formElement = $(this);
            const orderNumber = formElement.data('order-number');

            // Gather form fields
            const formData = {
                supplier_code: formElement.find('input[name="supplier_code"]').val(),
                order_number: formElement.find('input[name="order_number"]').val(),
                article_code: formElement.find('input[name="article_code"]').val(),
                order_price: formElement.find('input[name="order_price"]').val(),
                order_date: formElement.find('input[name="order_date"]').val(),
                delivery_date: formElement.find('input[name="delivery_date"]').val(),
                status: formElement.find('select[name="status"]').val()
            };

            // Make the PUT request to Django's update endpoint
            $.ajax({
                url: `/ordermanagement/orders/${orderNumber}/`,
                type: 'PUT',
                contentType: 'application/json',
                headers: {
                  'X-CSRFToken': csrftoken // Include CSRF token in request header
                },
                data: JSON.stringify(formData),
                success: function(response) {
                    alert('Order updated successfully!');
                    console.log("Response:", response);
                },
                error: function(err) {
                    alert('Error updating order: ' + err.responseText);
                    console.error(err);
                }
            });
        });
    });
</script>
{% endblock %}
