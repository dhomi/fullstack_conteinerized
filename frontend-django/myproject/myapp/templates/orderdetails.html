<!-- orderdetails.html -->
{% extends 'homepage.html' %}

{% block title %}Order Details{% endblock %}

{% block content %}
<meta name="description" content="Bootstrap.">
<link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<link rel="stylesheet" href="http://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css">
<script type="text/javascript" src="http://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

<h2>Order Details</h2>

<table id="myTable" class="table table-striped table-bordered table-responsive">
    <thead>
        <tr>
            <th>Supplier Code</th>
            <th>Order Number</th>
            <th>Product Code</th>
            <th>Product Name</th>
            <th>Order Price</th>
            <th>Order Date</th>
            <th>Delivery Date</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for order in orderdetails %}
            <tr>
                <form class="update-order-form" data-order-number="{{ order.order_number }}">
                    {% csrf_token %}
                    <td>{{ order.supplier_code }}</td>
                    <td>{{ order.order_number }}</td>
                    <td>{{ order.article_code }}</td>
                    <td>{{ order.article_name }}</td>
                    <td>
                        <div class="form-group">
                            <input type="text" name="order_price" value="{{ order.order_price }}" class="form-control input-sm">
                        </div>
                    </td>
                    <td>{{ order.order_date }}</td>
                    <td>
                        <div class="form-group">
                            <input type="date" name="delivery_date" value="{{ order.delivery_date }}" class="form-control input-sm">
                        </div>
                    </td>
                    <td>
                        <div class="form-group">
                            <select name="status" class="form-control input-sm">
                                <option value="P" {% if order.status == "P" %}selected{% endif %}>Pending</option>
                                <option value="C" {% if order.status == "C" %}selected{% endif %}>Cancelled</option>
                                <option value="S" {% if order.status == "S" %}selected{% endif %}>Shipped</option>
                                <option value="D" {% if order.status == "D" %}selected{% endif %}>Delivered</option>
                            </select>
                        </div>
                    </td>
                    <td>
                        <button type="submit" class="btn btn-primary btn-sm">Update</button>
                    </td>
                </form>
            </tr>
        {% endfor %}
    </tbody>
</table>

<div class="form-group">
    <button type="button" class="btn btn-default"><a href="/ordermanagement/orders" style="text-decoration: none; color: inherit;">Back to All Orders</a></button>
    <button type="button" class="btn btn-default"><a href="/suppliers" style="text-decoration: none; color: inherit;">Back to All Suppliers</a></button>
</div>

<script>
    $(document).ready(function(){
        $('#myTable').dataTable();

        // Bind the form submit event to send AJAX request
        $('form').on('submit', function(event) {
            event.preventDefault();  // Prevent the form from submitting normally

            // Extract the values from the form fields
            const orderNumber = $(this).find('input[name="order_number"]').val();
            const supplierCode = $(this).find('input[name="supplier_code"]').val();
            const orderPrice = $(this).find('input[name="order_price"]').val();
            const orderDate = $(this).find('input[name="order_date"]').val();
            const deliveryDate = $(this).find('input[name="delivery_date"]').val();
            const status = $(this).find('select[name="status"]').val();
            const status_description = $(this).find('select[name="status_descritpion"]').val();

            // Create the data object to send in the AJAX request
            const formData = {
                order_number: orderNumber,
                supplier_code: supplierCode,
                order_date: orderDate,
                delivery_date: deliveryDate,
                amount: orderPrice,
                status: status,
                status_description: status_description
            };

            // Make the AJAX request
            $.ajax({
                url: `http://localhost:8000/orders/${orderNumber}/`,  // Make sure this matches your API URL
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(formData),  // Convert form data to JSON string
                success: function(response) {
                    alert('Order updated successfully!');
                },
                error: function(xhr, status, error) {
                    console.error('Error:', xhr.responseText);
                    alert('Error updating order: ' + xhr.responseText);
                }
            });
        });
    });
</script>


{% endblock %}
