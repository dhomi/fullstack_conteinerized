<!-- templates/cart.html -->

{% extends 'homepage.html' %}

{% block title %}Your Cart{% endblock %}

{% block content %}
<meta name="description" content="View and manage your cart items.">
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css">
<script type="text/javascript" src="https://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

<div class="container" style="margin-top: 20px;">
  <h2>Your Cart</h2>

  {% if cart.items %}
    <table id="cartTable" class="table table-striped table-bordered table-sm">
      <thead>
        <tr>
          <th>Product Code</th>
          <th>Product Name</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Total Price</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in cart.items %}
          <tr id="cart-row-{{ item.article_code }}">
            <td>{{ item.article_code }}</td>
            <td>{{ item.article_name }}</td>
            <td>{{ item.price }}</td>
            <td>
              <input type="number" min="1" value="{{ item.quantity }}" onchange="updateCartItem({{ item.article_code }}, this.value)" />
            </td>
            <td>{{ item.total_price }}</td>
            <td>
              <button class="btn btn-danger btn-sm" onclick="removeCartItem({{ item.article_code }})">Remove</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <h3>Total: {{ cart.total_price }}</h3>
  {% else %}
    <p>Your cart is empty.</p>
  {% endif %}
</div>

<script>
  // Initialize DataTable with paging
  $(document).ready(function() {
    $('#cartTable').DataTable({
      paging: true,
      searching: true,
      ordering: true,
      info: true,
      autoWidth: false,
      pageLength: 8
    });
  });

  // Function to get CSRF token from cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Configure global AJAX to include the CSRF token for non-safe methods
  $.ajaxSetup({
    beforeSend: function(xhr, settings) {
      if (!(/^((GET|HEAD|OPTIONS|TRACE)$)/i.test(settings.type)) && !this.crossDomain) {
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
      }
    }
  });

  // Update cart item quantity
  function updateCartItem(articleCode, quantity) {
    if (quantity < 1) {
      alert("Quantity must be at least 1.");
      return;
    }

    $.ajax({
      url: `/cart/update/`,
      type: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify({
        "article_code": articleCode,
        "quantity": parseInt(quantity)
      }),
      success: function(response) {
        alert(response.message || "Cart item updated successfully!");
        updateCartCount(); // Update cart count without reloading
        // Optionally, update total price in the table
      },
      error: function(err) {
        const errorMsg = err.responseJSON && err.responseJSON.detail ? err.responseJSON.detail : "Failed to update cart item.";
        alert(errorMsg);
      }
    });
  }

  // Remove cart item
  function removeCartItem(articleCode) {
    if (!confirm("Are you sure you want to remove this item from your cart?")) return;

    $.ajax({
      url: `/cart/delete/${articleCode}/`,
      type: 'DELETE',
      success: function(response) {
        alert(response.message || "Cart item removed successfully!");
        updateCartCount(); // Update cart count without reloading
        $(`#cart-row-${articleCode}`).remove(); // Remove the row from the table
      },
      error: function(err) {
        const errorMsg = err.responseJSON && err.responseJSON.detail ? err.responseJSON.detail : "Failed to remove cart item.";
        alert(errorMsg);
      }
    });
  }

  // Function to update cart count dynamically
  function updateCartCount() {
    const token = "{{ request.session.access_token|default:'' }}";
    if (!token) {
      console.error("Access token not found in session.");
      return;
    }

    $.ajax({
      url: "{% url 'cart_count' %}",
      type: 'GET',
      headers: {
        "Authorization": `Bearer ${token}`
      },
      success: function(response) {
        $('#cart-count').text(response.cart_count);
      },
      error: function(err) {
        console.error("Failed to retrieve cart count.", err);
      }
    });
  }

  // Initial cart count update on page load
  $(document).ready(function() {
    updateCartCount();
  });
</script>
{% endblock %}
